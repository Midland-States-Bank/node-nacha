// Generated by CoffeeScript 1.11.1
var createBatch, credit, debit, ref, toDate, toYYMMDD, tomorrowDate, validate;

ref = require('./entry-ccd-ppd-web'), credit = ref.credit, debit = ref.debit;

validate = require('../validate');

toYYMMDD = require('../../dates').toYYMMDD;

tomorrowDate = function() {
  var today, tomorrow;
  today = new Date;
  tomorrow = today.setDate(today.getDate() + 1);
  return tomorrow;
};

toDate = function(dateOrString) {
  if ('string' === typeof dateOrString) {
    return dateOrString;
  }
  return toYYMMDD(dateOrString);
};

createBatch = function(whichKind, batchData) {
  var ach, batch, next, note, ref1, ref2;
  this.data.batchData = batchData;
  ach = this.object;
  batch = {
    recordType: '5',
    originatorStatusCode: '1',
    num: ach.batches.length,
    entryClassCode: whichKind,
    companyName: this.data.from.name,
    companyId: this.data.from.fein,
    originatingDFIIdentification: this.data["for"].dfi,
    effectiveDate: toDate((ref1 = batchData.effectiveDate) != null ? ref1 : tomorrowDate()),
    description: batchData.description,
    entries: [],
    footer: {
      recordType: '8',
      companyId: this.data.from.fein,
      originatingDFIIdentification: this.data["for"].dfi,
      num: ach.batches.length + 1,
      entryAndAddendaCount: 0,
      entryHash: 0,
      totalDebit: 0,
      totalCredit: 0
    }
  };
  if (batchData.date != null) {
    batch.date = batchData.date;
  }
  note = (ref2 = batchData.discretionaryData) != null ? ref2 : batchData.note;
  if (note != null) {
    batch.discretionaryData = note;
  }
  ach.batches.push(batch);
  ach.file.footer.batchCount++;
  ach.file.footer.lineCount += 2;
  ach.file.footer.blockCount = Math.ceil(ach.file.footer.lineCount / 10);
  return next = {
    credit: credit,
    debit: debit,
    data: this.data,
    object: ach,
    validate: validate.bind(ach, ach)
  };
};

module.exports = {
  ccd: function(batchData) {
    return createBatch.call(this, 'CCD', batchData);
  },
  ppd: function(batchData) {
    return createBatch.call(this, 'PPD', batchData);
  },
  web: function(batchData) {
    return createBatch.call(this, 'WEB', batchData);
  }
};
